<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPL Cognitive Core v15.0 (Automated)</title>
    <!-- Lade Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade D3.js für die Graph-Visualisierung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0f18; 
            background-image: radial-gradient(circle at 50% 10%, #152238 0%, #0a0f18 70%);
            color: #e5e7eb; 
            height: 100vh;
            overflow: hidden;
        }

        /* HUD & Neon Styles */
        .neon-text { color: #4dd0e1; text-shadow: 0 0 5px rgba(77, 208, 225, 0.5); }
        .hud-border { border: 1px solid rgba(40, 190, 255, 0.3); box-shadow: 0 0 15px rgba(40, 190, 255, 0.1); }
        .glass-panel { background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(8px); }
        
        /* Animationen */
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scan-effect {
            position: relative;
            overflow: hidden;
        }
        .scan-effect::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, transparent 0%, rgba(77, 208, 225, 0.1) 50%, transparent 100%);
            animation: scanline 3s linear infinite;
            pointer-events: none;
        }

        /* Terminal Style für Automation Logs */
        .terminal-output {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #10b981;
        }
    </style>
</head>
<body class="p-4 md:p-6 flex flex-col h-screen">

    <!-- Top Bar: System Status & CI/CD Status -->
    <header class="flex justify-between items-center mb-4 px-2">
        <div>
            <h1 class="text-2xl font-bold text-white tracking-wider flex items-center">
                <span class="text-cyan-400 mr-2">◈</span> EUYSTACIO KERNEL <span class="text-xs ml-2 bg-cyan-900 text-cyan-300 px-2 py-0.5 rounded">v15.0 AUTO</span>
            </h1>
        </div>
        <div class="flex space-x-4 text-xs font-mono">
            <div id="ci-status" class="flex items-center text-gray-500">
                <span class="w-2 h-2 rounded-full bg-gray-500 mr-2"></span> SELF-TEST: PENDING
            </div>
            <div id="db-status" class="flex items-center text-gray-500">
                <span class="w-2 h-2 rounded-full bg-gray-500 mr-2"></span> FIRESTORE: INIT
            </div>
        </div>
    </header>

    <div class="flex flex-1 gap-6 overflow-hidden">
        
        <!-- LINKS: Input & Generator (Active Workspace) -->
        <div class="w-2/3 flex flex-col gap-4">
            
            <!-- Generator Panel -->
            <div class="glass-panel hud-border rounded-xl p-6 flex flex-col h-2/3 scan-effect relative">
                <div class="flex justify-between mb-4">
                    <h2 class="text-lg font-semibold text-white">Cognitive Processing Unit</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-cyan-400">AUTO-GROUNDING:</span>
                        <div class="w-8 h-4 bg-cyan-900 rounded-full relative">
                            <div class="absolute right-1 top-1 w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_5px_#4dd0e1]"></div>
                        </div>
                    </div>
                </div>

                <!-- Smart Input Area -->
                <div class="relative mb-4">
                    <textarea id="user-query" 
                        class="w-full bg-gray-900/80 border border-gray-700 rounded-lg p-4 text-white focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 outline-none transition-all resize-none"
                        rows="3" 
                        placeholder="Initialisiere Anfrage... (System analysiert Kontext automatisch)"></textarea>
                    
                    <!-- Automatisierte Vorschläge (Hidden by default) -->
                    <div id="auto-suggestion" class="absolute bottom-4 right-4 text-xs text-cyan-600 hidden">
                        ⟳ Kontext wird analysiert...
                    </div>
                </div>

                <!-- Generierte Antwort -->
                <div class="flex-1 bg-black/40 rounded-lg border border-gray-800 p-4 overflow-y-auto font-mono text-sm text-gray-300" id="response-output">
                    <span class="text-gray-600">> Warten auf Input...</span>
                </div>

                <!-- Controls -->
                <div class="mt-4 flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-toggle" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"></div>
                            <span class="ml-2 text-xs font-medium text-gray-400">JSON Mode</span>
                        </label>
                    </div>
                    <button id="generate-btn" class="bg-cyan-700 hover:bg-cyan-600 text-white px-6 py-2 rounded-lg font-bold transition-all shadow-[0_0_10px_rgba(6,182,212,0.3)] flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>EXECUTE</span>
                    </button>
                </div>
            </div>

            <!-- Automation Log (Live Terminal) -->
            <div class="glass-panel hud-border rounded-xl p-4 flex-1 flex flex-col">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b border-gray-800 pb-1">Automated Process Log (Live)</h3>
                <div id="automation-log" class="flex-1 overflow-y-auto terminal-output space-y-1">
                    <div>[SYS] Terminal initialized.</div>
                    <div>[SYS] Warten auf Auto-Generation Module...</div>
                </div>
            </div>

        </div>

        <!-- RECHTS: Context Intelligence & Graph -->
        <div class="w-1/3 flex flex-col gap-4">
            
            <!-- Active Context Intelligence -->
            <div class="glass-panel hud-border rounded-xl p-4 h-1/2 flex flex-col">
                <h2 class="text-sm font-bold text-cyan-400 mb-3 uppercase tracking-wide">Active Context Matrix</h2>
                
                <div class="flex-1 bg-gray-900/50 rounded border border-gray-800 p-3 mb-3 overflow-y-auto">
                    <div id="context-status" class="text-xs text-gray-500 italic text-center mt-10">Kein aktiver Kontext verknüpft.</div>
                    <ul id="context-keywords-list" class="hidden space-y-2">
                        <!-- Dynamisch gefüllt -->
                    </ul>
                </div>

                <div class="bg-gray-800 p-2 rounded border border-gray-700">
                    <div class="text-[10px] text-gray-500 uppercase mb-1">Autogenerierte Queries (Preview)</div>
                    <div id="query-preview" class="text-xs text-green-400 font-mono truncate">...</div>
                </div>
            </div>

            <!-- Memory Graph (Mini) -->
            <div class="glass-panel hud-border rounded-xl p-4 flex-1 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-bold text-purple-400 uppercase tracking-wide">Neural Memory</h2>
                    <span id="session-count" class="text-xs text-gray-500">0 Nodes</span>
                </div>
                <div id="mini-graph" class="flex-1 bg-gray-900/30 rounded border border-gray-800 relative overflow-hidden">
                    <!-- D3 Graph Container -->
                    <svg id="d3-graph" width="100%" height="100%"></svg>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURATION ---
        const API_KEY = ""; // Canvas Environment Key
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        
        // Logger
        const log = (msg, type = 'INFO') => {
            const el = document.getElementById('automation-log');
            const colors = { 'INFO': '#10b981', 'AUTO': '#3b82f6', 'API': '#f59e0b', 'ERR': '#ef4444' };
            const line = document.createElement('div');
            line.style.color = colors[type] || '#ccc';
            line.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString()}]</span> [${type}] ${msg}`;
            el.appendChild(line);
            el.scrollTop = el.scrollHeight;
        };

        // --- 1. AUTOMATION ENGINE (Logik-Klassen) ---

        class AutoContextEngine {
            constructor() {
                this.stopwords = new Set(['der', 'die', 'das', 'und', 'ist', 'für', 'mit', 'von', 'den', 'eine', 'was', 'wie']);
            }

            extractKeywords(text) {
                if (!text) return [];
                const words = text.toLowerCase().replace(/[^\w\säöüß]/g, '').split(/\s+/);
                const keywords = words.filter(w => w.length > 3 && !this.stopwords.has(w));
                // Simple Frequenz-Analyse (Mock) - nimm unique, max 5
                return [...new Set(keywords)].slice(0, 5);
            }
        }

        class DynamicQueryBuilder {
            constructor(contextEngine) {
                this.engine = contextEngine;
            }

            buildQueries(userQuery, contextData) {
                const queries = [];
                // 1. Primär-Query
                queries.push(userQuery);

                // 2. Kontext-Query (Automatisch generiert)
                if (contextData && contextData.keywords.length > 0) {
                    const contextString = contextData.keywords.join(' ');
                    queries.push(`${userQuery} related to ${contextString}`);
                    queries.push(`latest news: ${contextString}`);
                }

                return queries;
            }
        }

        // --- 2. CI/CD SIMULATION (Selbsttest beim Start) ---

        function runSelfTest() {
            const statusEl = document.getElementById('ci-status');
            log("Starte interne System-Tests...", "AUTO");
            
            const engine = new AutoContextEngine();
            const testText = "Der Preis von Bitcoin ist gestiegen.";
            const keywords = engine.extractKeywords(testText);
            
            if (keywords.includes('bitcoin') && keywords.includes('preis')) {
                log("✔ Unit Test: Keyword Extraction [PASS]", "INFO");
                
                const builder = new DynamicQueryBuilder(engine);
                const queries = builder.buildQueries("Analyse", { keywords: ['bitcoin'] });
                
                if (queries.length >= 2) {
                    log("✔ Unit Test: Query Generation [PASS]", "INFO");
                    statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> SELF-TEST: PASSED';
                    statusEl.classList.add('text-green-500');
                    return true;
                }
            }
            
            log("✖ Unit Test Failed", "ERR");
            statusEl.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span> SELF-TEST: FAIL';
            return false;
        }

        // --- 3. APPLICATION LOGIC ---

        let db, auth, userId;
        let activeContext = null;
        const contextEngine = new AutoContextEngine();
        const queryBuilder = new DynamicQueryBuilder(contextEngine);

        async function initApp() {
            runSelfTest(); // CI/CD Check

            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            if (!firebaseConfig.apiKey) {
                log("Firebase Config fehlt - Offline Mode", "ERR");
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            await signInAnonymously(auth);
            userId = auth.currentUser.uid;
            
            document.getElementById('db-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> FIRESTORE: ONLINE';
            log(`Connected as ${userId}`, "INFO");

            initGraphListener();
        }

        async function handleGenerate() {
            const inputEl = document.getElementById('user-query');
            const queryText = inputEl.value.trim();
            if (!queryText) return;

            const btn = document.getElementById('generate-btn');
            const output = document.getElementById('response-output');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin mr-2">⟳</span> PROCESSING';
            output.innerHTML = '<span class="animate-pulse text-cyan-500">... Generiere Gedanken ...</span>';

            // 1. AUTOMATISIERUNG: Kontext Analyse
            let contextKeywords = [];
            if (activeContext) {
                contextKeywords = contextEngine.extractKeywords(activeContext.query + " " + activeContext.response);
                log(`Auto-Extracted Keywords: ${contextKeywords.join(', ')}`, "AUTO");
            }

            // 2. AUTOGENERIERUNG: Queries
            const apiQueries = queryBuilder.buildQueries(queryText, { keywords: contextKeywords });
            log(`Generated API Queries: ${JSON.stringify(apiQueries)}`, "AUTO");

            // 3. API Call
            try {
                const response = await callGemini(queryText, apiQueries);
                output.innerText = response;
                log("Response received & rendered", "API");
                
                // Save to Firestore (Memory)
                await saveSession(queryText, response);

            } catch (e) {
                output.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
                log(e.message, "ERR");
            }

            btn.disabled = false;
            btn.innerText = 'EXECUTE';
        }

        async function callGemini(userText, toolsQueries) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            
            // Construct History Context
            const contents = [];
            if (activeContext) {
                contents.push({ role: 'user', parts: [{ text: `Context: ${activeContext.query}` }]});
                contents.push({ role: 'model', parts: [{ text: `Context Result: ${activeContext.response}` }]});
            }
            contents.push({ role: 'user', parts: [{ text: userText }]});

            const payload = {
                contents: contents,
                tools: [{ google_search: { queries: toolsQueries } }]
            };

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
        }

        async function saveSession(q, r) {
            if (!db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/sessions`), {
                query: q,
                response: r,
                timestamp: new Date().toISOString(),
                linkedContext: activeContext ? activeContext.id : null
            });
            log("Session automatically archived in Memory Graph", "INFO");
        }

        // --- 4. VISUALISIERUNG (D3 Graph) ---
        function initGraphListener() {
            if (!db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/sessions`), orderBy('timestamp', 'desc'), limit(20));

            onSnapshot(q, (snapshot) => {
                const nodes = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('session-count').innerText = `${nodes.length} Nodes`;
                updateGraph(nodes);
                
                // Set latest as active context automatically (Auto-Flow)
                if (nodes.length > 0) {
                    activeContext = nodes[0]; // Last session becomes context
                    updateContextUI(nodes[0]);
                }
            });
        }

        function updateContextUI(node) {
            const container = document.getElementById('context-status');
            const list = document.getElementById('context-keywords-list');
            
            container.classList.add('hidden');
            list.classList.remove('hidden');
            list.innerHTML = '';

            const kws = contextEngine.extractKeywords(node.query);
            kws.forEach(kw => {
                list.innerHTML += `<li class="text-xs bg-cyan-900/40 text-cyan-300 px-2 py-1 rounded inline-block mr-1 mb-1 border border-cyan-800">${kw}</li>`;
            });

            document.getElementById('query-preview').innerText = `Query >> ${node.query.substring(0,30)}...`;
        }

        function updateGraph(data) {
            // Simple D3 Logic for Micro-Graph
            const svg = d3.select("#d3-graph");
            svg.selectAll("*").remove();
            
            const width = document.getElementById('mini-graph').clientWidth;
            const height = document.getElementById('mini-graph').clientHeight;

            const simulation = d3.forceSimulation(data)
                .force("charge", d3.forceManyBody().strength(-50))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(10));

            const node = svg.selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("r", 5)
                .attr("fill", "#4dd0e1")
                .call(d3.drag()
                    .on("start", (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                    .on("drag", (e, d) => { d.fx = e.x; d.fy = e.y; })
                    .on("end", (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }));

            simulation.on("tick", () => {
                node.attr("cx", d => d.x).attr("cy", d => d.y);
            });
        }

        // Start
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('generate-btn').addEventListener('click', handleGenerate);
            initApp();
        });

    </script>
</body>
</html>
